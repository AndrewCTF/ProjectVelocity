# Velocity Easy-Config & Auto-HTTPS Plan

> Goal: Deliver a “one-command” experience that provisions Velocity with sensible defaults, issues hybrid TLS certificates automatically, and keeps the deployment maintainable for operators with minimal PQ expertise.

## 1. Product framing

1. **Problem statement**
   - Manual nginx/front-door setup is error prone and duplicates logic already present in the Velocity runtime.
   - Operators want HTTPS by default without stitching together certbot hooks, hybridization steps, and Velocity config.
2. **North-star experience**
   - `velocity-cli easy` bootstraps the environment, issues/renews certs, and writes an opinionated config.
   - Subsequent `velocity-cli easy update` refreshes certs/configs with zero downtime.
3. **Success metrics**
   - First run to serving HTTPS payloads in `< 10 minutes` without editing YAML.
   - Automated certificate renewal with > 99% success across pilot cohorts.

## 2. Architecture outline

1. **CLI wizard**
   - Collect domain(s), contact email, and hosting mode (static vs reverse proxy).
   - Validate system prerequisites (UDP 443 open, Rust/Node versions, systemd availability).
2. **Config generator**
   - Emit `easy-config.yaml` with curated defaults:
     - balanced profile target
     - telemetry endpoints enabled
     - automatic fallback to HTTP/3 on downgrade
   - Template for static root *and* upstream proxy to cover common scenarios.
3. **Certificate automation**
   - Integrate ACME flow directly:
     - HTTP-01 for single host, DNS-01 plugin hooks for wildcard.
     - Hybridize certificate automatically and store in `/etc/velocity/easy/`.
   - Schedule renewals via systemd timer generated by CLI.
4. **Runtime launcher**
   - Systemd unit drop-in (`velocity-easy.service`) using sanitized sandbox profile.
   - For non-systemd environments, generate `docker-compose.yaml` using the same assets.
5. **Observability**
   - Wire Prometheus endpoint and structured logs to files by default.
   - Provide optional “send to stdout” flag for container logs.

## 3. Implementation phases

### Phase 0 — Research & UX prototype (1 week)
- Capture friction points from current manual setup.
- Draft CLI flow and validate copy with 2 pilot operators.
- Decide on ACME library (e.g., `acme-client` crate) and DNS provider abstraction.

### Phase 1 — Minimal viable wizard (2 weeks)
- Implement `velocity-cli easy bootstrap`:
  - prerequisite checks
  - config generation (static site + reverse proxy templates)
  - ACME HTTP-01 issuance
  - hybrid certificate creation
- Unit tests for config rendering & certificate pipeline.

### Phase 2 — Runtime integration (2 weeks)
- Generate systemd unit + timer files (`velocity-easy.service`, `velocity-easy.timer`).
- Add `velocity-cli easy enable` to install/reload systemd units.
- Provide `easy status` command for health summary (service state, cert expiry, telemetry URL).
- Integration tests using containerized Ubuntu image.

### Phase 3 — Renewal & resilience (1 week)
- Implement renewal timer hook (`velocity-cli easy renew`).
- Add failure notifications (optional email/webhook).
- Document rollback (`velocity-cli easy disable`).

### Phase 4 — Extended features (ongoing)
- DNS-01 providers (Route53, Cloudflare, Azure DNS).
- Multi-domain support with SANs.
- Optional HA recipe using keepalived or cloud load balancer.
- UI/UX polish (progress spinners, color output, helpful hints).

## 4. Automation & testing strategy

- **Unit tests**: config templates, ACME request/response parsing, hybridization workflow.
- **Integration tests**: run inside GitHub Actions using `act` or container job, verifying end-to-end issuance against Pebble ACME server.
- **Load testing**: ensure repeated renewals do not leak files or secrets.
- **Security review**: secrets stored with correct permissions (0600), sanitized logs, consistent error handling.

## 5. Documentation deliverables

- `docs/easy-config.md`: operator walkthrough.
- Update `docs/deployment.md` with new quickstart.
- Tutorial video/script for marketing site.
- Troubleshooting appendix (firewall issues, ACME rate limits, DNS propagation).

## 6. Rollout plan

1. Ship as experimental feature behind `velocity-cli easy --preview`.
2. Collect feedback from internal team + selected users.
3. Iterate on UX, finalize automation hooks.
4. Announce stable availability in next minor release (`v0.3`).

## 7. Open questions & risks

- **ACME dependency**: choose crate with long-term maintenance or vendor our own.
- **Hybrid cert issuance**: ensure compatibility with Let’s Encrypt renewal cadence.
- **Non-systemd platforms**: need fallback instructions (cron + `velocity-cli`).
- **Security posture**: guard against privilege escalation when writing configs/secrets.

---

This plan prioritizes rapid time-to-value while preserving Velocity’s security guarantees. Each phase can be shipped incrementally, providing value to operators even before the full automation suite lands.
